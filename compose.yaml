name: simple-gantt

x-backend-build: &backend-build
  context: .
  dockerfile: Dockerfile
  target: runtime-backend

x-frontend-build: &frontend-build
  context: .
  dockerfile: Dockerfile
  target: runtime-frontend
  args:
    VITE_TASKS_DATA_SOURCE: api
    VITE_API_BASE_URL: /

services:
  db-migrate:
    image: simple-gantt-backend:latest
    build: *backend-build
    command:
      [
        'pnpm',
        '--filter',
        '@simple-gantt/backend',
        'exec',
        'prisma',
        'db',
        'push',
        '--skip-generate',
        '--schema',
        '../prisma/schema.prisma'
      ]
    environment:
      DATABASE_URL: file:/data/simple-gantt.db
      SQLITE_BUSY_TIMEOUT_MS: 5000
    volumes:
      - sqlite_data:/data
    restart: 'no'

  backend:
    image: simple-gantt-backend:latest
    build: *backend-build
    command: ['node', '--conditions=production', 'backend/dist/index.js']
    depends_on:
      db-migrate:
        condition: service_completed_successfully
    environment:
      DATABASE_URL: file:/data/simple-gantt.db
      SQLITE_BUSY_TIMEOUT_MS: 5000
      API_PORT: 8787
      CORS_ORIGIN: '*'
      LOG_LEVEL: info
    volumes:
      - sqlite_data:/data
      - backend_logs:/app/backend/logs
    expose:
      - '8787'
    restart: unless-stopped
    healthcheck:
      test:
        [
          'CMD-SHELL',
          'node -e "fetch(''http://localhost:8787/api/health'').then((r)=>process.exit(r.ok?0:1)).catch(()=>process.exit(1))"'
        ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s

  frontend:
    image: simple-gantt-frontend:latest
    build: *frontend-build
    expose:
      - '80'
    restart: unless-stopped
    healthcheck:
      test: ['CMD-SHELL', 'nginx -t > /dev/null 2>&1 || exit 1']
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s

  gateway:
    image: nginx:1.29-alpine
    depends_on:
      backend:
        condition: service_healthy
      frontend:
        condition: service_healthy
    ports:
      - '${APP_PORT:-8080}:80'
    volumes:
      - ./docker/nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
    restart: unless-stopped
    healthcheck:
      test: ['CMD-SHELL', 'wget -qO- http://127.0.0.1/ > /dev/null || exit 1']
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

volumes:
  sqlite_data:
  backend_logs:
