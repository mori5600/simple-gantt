name: simple-gantt

x-app-build: &app-build
  context: .
  dockerfile: Dockerfile
  target: runtime
  args:
    VITE_TASKS_DATA_SOURCE: api
    VITE_API_BASE_URL: /

services:
  backend:
    image: simple-gantt-app:latest
    build: *app-build
    command: >
      sh -c "pnpm --filter @simple-gantt/backend exec prisma db push --skip-generate --schema ../prisma/schema.prisma
      && pnpm --filter @simple-gantt/backend exec tsx src/index.ts"
    environment:
      DATABASE_URL: file:/data/simple-gantt.db
      SQLITE_BUSY_TIMEOUT_MS: 5000
      API_PORT: 8787
      CORS_ORIGIN: '*'
      LOG_LEVEL: info
    volumes:
      - sqlite_data:/data
      - backend_logs:/app/backend/logs
    expose:
      - '8787'
    restart: unless-stopped
    healthcheck:
      test:
        [
          'CMD-SHELL',
          'node -e "fetch(''http://localhost:8787/api/health'').then((r)=>process.exit(r.ok?0:1)).catch(()=>process.exit(1))"'
        ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s

  frontend:
    image: simple-gantt-app:latest
    build: *app-build
    command: ['node', 'frontend/build']
    environment:
      HOST: 0.0.0.0
      PORT: 4173
      NODE_ENV: production
    expose:
      - '4173'
    restart: unless-stopped
    healthcheck:
      test:
        [
          'CMD-SHELL',
          'node -e "fetch(''http://localhost:4173'').then((r)=>process.exit(r.ok?0:1)).catch(()=>process.exit(1))"'
        ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s

  gateway:
    image: nginx:1.27-alpine
    depends_on:
      backend:
        condition: service_healthy
      frontend:
        condition: service_healthy
    ports:
      - '${APP_PORT:-8080}:80'
    volumes:
      - ./docker/nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
    restart: unless-stopped
    healthcheck:
      test: ['CMD-SHELL', 'wget -qO- http://localhost/ > /dev/null || exit 1']
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

volumes:
  sqlite_data:
  backend_logs:
